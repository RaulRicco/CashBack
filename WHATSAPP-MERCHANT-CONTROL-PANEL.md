# WhatsApp Merchant Control Panel - Painel de Controle de AutomaÃ§Ãµes

**Data**: 2026-01-03  
**Status**: Planejamento - SoluÃ§Ã£o para Auto-ConfiguraÃ§Ã£o  
**Autor**: GenSpark AI Developer  

---

## ğŸ¯ **Objetivo**

Permitir que o **merchant configure automaÃ§Ãµes de WhatsApp** sem precisar mexer com a Meta diretamente.

---

## âœ… **O QUE O MERCHANT PODE CONFIGURAR**

### **Painel de AutomaÃ§Ãµes de AniversÃ¡rio**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ‚ AutomaÃ§Ãµes de AniversÃ¡rio                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  âš™ï¸ ConfiguraÃ§Ãµes Gerais                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ âœ… Ativar automaÃ§Ãµes de aniversÃ¡rio                    â”‚    â”‚
â”‚  â”‚ ğŸ• HorÃ¡rio de envio: [09:00] â–¼                         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“… Mensagem de PrÃ©-AniversÃ¡rio                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ âœ… Enviar mensagem antes do aniversÃ¡rio                â”‚    â”‚
â”‚  â”‚ ğŸ“† Enviar com [30] â–¼ dias de antecedÃªncia              â”‚    â”‚
â”‚  â”‚    OpÃ§Ãµes: 7, 15, 30, 60 dias                          â”‚    â”‚
â”‚  â”‚                                                         â”‚    â”‚
â”‚  â”‚ ğŸ Oferta de cashback extra: [15]% â–¼                   â”‚    â”‚
â”‚  â”‚    OpÃ§Ãµes: 10%, 15%, 20%, 25%, 30%                     â”‚    â”‚
â”‚  â”‚                                                         â”‚    â”‚
â”‚  â”‚ ğŸ“ Preview da mensagem:                                â”‚    â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚  â”‚ â”‚ ğŸ‰ OlÃ¡ JoÃ£o! Seu aniversÃ¡rio estÃ¡ chegando!      â”‚   â”‚    â”‚
â”‚  â”‚ â”‚                                                  â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ Faltam apenas 30 dias para o seu grande dia      â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ e preparamos algo especial:                      â”‚   â”‚    â”‚
â”‚  â”‚ â”‚                                                  â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ ğŸ 15% DE CASHBACK EXTRA em todas as suas       â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ compras atÃ© o dia do seu aniversÃ¡rio!           â”‚   â”‚    â”‚
â”‚  â”‚ â”‚                                                  â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ Aproveite agora: [Link Dashboard]               â”‚   â”‚    â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                  â”‚
â”‚  ğŸ‚ Mensagem no Dia do AniversÃ¡rio                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ âœ… Enviar mensagem no dia do aniversÃ¡rio               â”‚    â”‚
â”‚  â”‚                                                         â”‚    â”‚
â”‚  â”‚ ğŸ’° BÃ´nus de aniversÃ¡rio: R$ [10,00]                    â”‚    â”‚
â”‚  â”‚    OpÃ§Ãµes: R$ 5, R$ 10, R$ 15, R$ 20, R$ 50           â”‚    â”‚
â”‚  â”‚                                                         â”‚    â”‚
â”‚  â”‚ ğŸ Cashback extra no dia: [20]% â–¼                      â”‚    â”‚
â”‚  â”‚    OpÃ§Ãµes: 15%, 20%, 25%, 30%, 50%                     â”‚    â”‚
â”‚  â”‚                                                         â”‚    â”‚
â”‚  â”‚ ğŸ“ Preview da mensagem:                                â”‚    â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚  â”‚ â”‚ ğŸ‚ PARABÃ‰NS, JoÃ£o! ğŸ‰                            â”‚   â”‚    â”‚
â”‚  â”‚ â”‚                                                  â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ Hoje Ã© o SEU dia! Para comemorar, vocÃª ganhou:  â”‚   â”‚    â”‚
â”‚  â”‚ â”‚                                                  â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ ğŸ R$ 10,00 de BÃ”NUS direto na sua conta!       â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ ğŸ’° 20% de CASHBACK EXTRA em todas as compras    â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ hoje!                                            â”‚   â”‚    â”‚
â”‚  â”‚ â”‚                                                  â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ Seu saldo atual: R$ 45,00                       â”‚   â”‚    â”‚
â”‚  â”‚ â”‚                                                  â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ Acesse: [Link Dashboard]                        â”‚   â”‚    â”‚
â”‚  â”‚ â”‚                                                  â”‚   â”‚    â”‚
â”‚  â”‚ â”‚ Feliz AniversÃ¡rio! ğŸ¥³                            â”‚   â”‚    â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“Š EstatÃ­sticas (Ãšltimos 30 dias)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ğŸ“… Mensagens prÃ©-aniversÃ¡rio enviadas: 12             â”‚    â”‚
â”‚  â”‚  ğŸ‚ Mensagens de aniversÃ¡rio enviadas: 8               â”‚    â”‚
â”‚  â”‚  ğŸ’° Total em bÃ´nus concedidos: R$ 80,00                â”‚    â”‚
â”‚  â”‚  âœ… Taxa de sucesso: 100%                              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                  â”‚
â”‚  [ğŸ’¾ Salvar ConfiguraÃ§Ãµes]  [ğŸ‘ï¸ Ver PrÃ³ximos Aniversariantes] â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ **Estrutura de Dados (Database)**

### **Nova tabela: `whatsapp_automation_settings`**

```sql
CREATE TABLE whatsapp_automation_settings (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  merchant_id UUID NOT NULL REFERENCES merchants(id) ON DELETE CASCADE,
  
  -- ConfiguraÃ§Ãµes gerais
  is_active BOOLEAN DEFAULT true,
  send_hour INTEGER DEFAULT 9, -- HorÃ¡rio de envio (0-23)
  
  -- PrÃ©-aniversÃ¡rio
  pre_birthday_enabled BOOLEAN DEFAULT true,
  pre_birthday_days INTEGER DEFAULT 30, -- 7, 15, 30, 60
  pre_birthday_cashback_extra INTEGER DEFAULT 15, -- Porcentagem (10-50)
  
  -- Dia do aniversÃ¡rio
  birthday_enabled BOOLEAN DEFAULT true,
  birthday_bonus_amount DECIMAL(10,2) DEFAULT 10.00, -- Valor do bÃ´nus
  birthday_cashback_extra INTEGER DEFAULT 20, -- Porcentagem (15-50)
  
  -- Metadados
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Ãndice
CREATE UNIQUE INDEX idx_whatsapp_auto_merchant ON whatsapp_automation_settings(merchant_id);

-- ComentÃ¡rio
COMMENT ON TABLE whatsapp_automation_settings IS 'ConfiguraÃ§Ãµes de automaÃ§Ãµes de WhatsApp por merchant';
```

---

## ğŸ’» **ImplementaÃ§Ã£o Backend**

### **Endpoint para salvar configuraÃ§Ãµes**

```javascript
// server.js

// Endpoint: Salvar configuraÃ§Ãµes de automaÃ§Ã£o
app.post('/api/whatsapp/automation/settings', async (req, res) => {
  try {
    const {
      merchantId,
      isActive,
      sendHour,
      preBirthdayEnabled,
      preBirthdayDays,
      preBirthdayCashbackExtra,
      birthdayEnabled,
      birthdayBonusAmount,
      birthdayCashbackExtra
    } = req.body;
    
    // ValidaÃ§Ãµes
    if (!merchantId) {
      return res.status(400).json({ error: 'merchantId Ã© obrigatÃ³rio' });
    }
    
    if (sendHour < 0 || sendHour > 23) {
      return res.status(400).json({ error: 'sendHour deve estar entre 0 e 23' });
    }
    
    if (![7, 15, 30, 60].includes(preBirthdayDays)) {
      return res.status(400).json({ error: 'preBirthdayDays deve ser 7, 15, 30 ou 60' });
    }
    
    // Verificar se merchant existe
    const { data: merchant, error: merchantError } = await supabase
      .from('merchants')
      .select('id')
      .eq('id', merchantId)
      .single();
    
    if (merchantError || !merchant) {
      return res.status(404).json({ error: 'Merchant nÃ£o encontrado' });
    }
    
    // Upsert (insert ou update)
    const { data, error } = await supabase
      .from('whatsapp_automation_settings')
      .upsert({
        merchant_id: merchantId,
        is_active: isActive,
        send_hour: sendHour,
        pre_birthday_enabled: preBirthdayEnabled,
        pre_birthday_days: preBirthdayDays,
        pre_birthday_cashback_extra: preBirthdayCashbackExtra,
        birthday_enabled: birthdayEnabled,
        birthday_bonus_amount: birthdayBonusAmount,
        birthday_cashback_extra: birthdayCashbackExtra,
        updated_at: new Date().toISOString()
      }, {
        onConflict: 'merchant_id'
      })
      .select()
      .single();
    
    if (error) {
      console.error('Erro ao salvar configuraÃ§Ãµes:', error);
      return res.status(500).json({ error: 'Erro ao salvar configuraÃ§Ãµes' });
    }
    
    console.log(`âœ… ConfiguraÃ§Ãµes de automaÃ§Ã£o salvas para merchant ${merchantId}`);
    res.json({ success: true, data });
    
  } catch (error) {
    console.error('Erro no endpoint de configuraÃ§Ãµes:', error);
    res.status(500).json({ error: 'Erro interno do servidor' });
  }
});

// Endpoint: Buscar configuraÃ§Ãµes
app.get('/api/whatsapp/automation/settings/:merchantId', async (req, res) => {
  try {
    const { merchantId } = req.params;
    
    const { data, error } = await supabase
      .from('whatsapp_automation_settings')
      .select('*')
      .eq('merchant_id', merchantId)
      .single();
    
    if (error && error.code !== 'PGRST116') { // PGRST116 = nÃ£o encontrado
      console.error('Erro ao buscar configuraÃ§Ãµes:', error);
      return res.status(500).json({ error: 'Erro ao buscar configuraÃ§Ãµes' });
    }
    
    // Se nÃ£o existir, retornar configuraÃ§Ãµes padrÃ£o
    if (!data) {
      return res.json({
        isActive: true,
        sendHour: 9,
        preBirthdayEnabled: true,
        preBirthdayDays: 30,
        preBirthdayCashbackExtra: 15,
        birthdayEnabled: true,
        birthdayBonusAmount: 10.00,
        birthdayCashbackExtra: 20
      });
    }
    
    res.json(data);
    
  } catch (error) {
    console.error('Erro no endpoint de configuraÃ§Ãµes:', error);
    res.status(500).json({ error: 'Erro interno do servidor' });
  }
});

// Endpoint: EstatÃ­sticas de aniversÃ¡rios
app.get('/api/whatsapp/automation/stats/:merchantId', async (req, res) => {
  try {
    const { merchantId } = req.params;
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    
    // Buscar logs dos Ãºltimos 30 dias
    const { data: logs, error } = await supabase
      .from('whatsapp_birthday_logs')
      .select('notification_type, bonus_amount, status')
      .eq('merchant_id', merchantId)
      .gte('sent_at', thirtyDaysAgo.toISOString());
    
    if (error) {
      console.error('Erro ao buscar estatÃ­sticas:', error);
      return res.status(500).json({ error: 'Erro ao buscar estatÃ­sticas' });
    }
    
    // Calcular estatÃ­sticas
    const preBirthdayCount = logs.filter(l => l.notification_type === '30_days_before').length;
    const birthdayCount = logs.filter(l => l.notification_type === 'birthday_day').length;
    const totalBonus = logs
      .filter(l => l.notification_type === 'birthday_day' && l.status === 'sent')
      .reduce((sum, l) => sum + (l.bonus_amount || 0), 0);
    const successRate = logs.length > 0 
      ? (logs.filter(l => l.status === 'sent').length / logs.length * 100).toFixed(1)
      : 0;
    
    res.json({
      preBirthdayCount,
      birthdayCount,
      totalBonus,
      successRate
    });
    
  } catch (error) {
    console.error('Erro no endpoint de estatÃ­sticas:', error);
    res.status(500).json({ error: 'Erro interno do servidor' });
  }
});

// Endpoint: PrÃ³ximos aniversariantes
app.get('/api/whatsapp/automation/upcoming/:merchantId', async (req, res) => {
  try {
    const { merchantId } = req.params;
    const { days = 30 } = req.query; // Quantos dias Ã  frente
    
    const today = new Date();
    const futureDate = new Date();
    futureDate.setDate(futureDate.getDate() + parseInt(days));
    
    const { data: customers, error } = await supabase
      .from('customers')
      .select('id, name, phone, birthdate, cashback_balance')
      .eq('merchant_id', merchantId)
      .not('birthdate', 'is', null)
      .gte('birthdate', today.toISOString().split('T')[0])
      .lte('birthdate', futureDate.toISOString().split('T')[0])
      .order('birthdate', { ascending: true });
    
    if (error) {
      console.error('Erro ao buscar aniversariantes:', error);
      return res.status(500).json({ error: 'Erro ao buscar aniversariantes' });
    }
    
    res.json(customers || []);
    
  } catch (error) {
    console.error('Erro no endpoint de aniversariantes:', error);
    res.status(500).json({ error: 'Erro interno do servidor' });
  }
});
```

---

## ğŸ¨ **Frontend - Painel de Controle**

```javascript
// cashback-system/src/pages/WhatsAppAutomation.jsx
import React, { useState, useEffect } from 'react';
import { createClient } from '@supabase/supabase-js';
import { useAuth } from '../contexts/AuthContext';

const supabase = createClient(
  import.meta.env.VITE_SUPABASE_URL,
  import.meta.env.VITE_SUPABASE_ANON_KEY
);

export default function WhatsAppAutomation() {
  const { user } = useAuth();
  const [settings, setSettings] = useState({
    isActive: true,
    sendHour: 9,
    preBirthdayEnabled: true,
    preBirthdayDays: 30,
    preBirthdayCashbackExtra: 15,
    birthdayEnabled: true,
    birthdayBonusAmount: 10.00,
    birthdayCashbackExtra: 20
  });
  const [stats, setStats] = useState(null);
  const [upcoming, setUpcoming] = useState([]);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);

  useEffect(() => {
    if (user?.merchant_id) {
      loadSettings();
      loadStats();
      loadUpcoming();
    }
  }, [user]);

  async function loadSettings() {
    try {
      const response = await fetch(`/api/whatsapp/automation/settings/${user.merchant_id}`);
      const data = await response.json();
      setSettings(data);
    } catch (error) {
      console.error('Erro ao carregar configuraÃ§Ãµes:', error);
    } finally {
      setLoading(false);
    }
  }

  async function loadStats() {
    try {
      const response = await fetch(`/api/whatsapp/automation/stats/${user.merchant_id}`);
      const data = await response.json();
      setStats(data);
    } catch (error) {
      console.error('Erro ao carregar estatÃ­sticas:', error);
    }
  }

  async function loadUpcoming() {
    try {
      const response = await fetch(`/api/whatsapp/automation/upcoming/${user.merchant_id}?days=30`);
      const data = await response.json();
      setUpcoming(data);
    } catch (error) {
      console.error('Erro ao carregar aniversariantes:', error);
    }
  }

  async function handleSave() {
    setSaving(true);
    try {
      const response = await fetch('/api/whatsapp/automation/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          merchantId: user.merchant_id,
          ...settings
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        alert('âœ… ConfiguraÃ§Ãµes salvas com sucesso!');
      } else {
        alert('âŒ Erro ao salvar: ' + data.error);
      }
    } catch (error) {
      console.error('Erro ao salvar:', error);
      alert('âŒ Erro ao salvar configuraÃ§Ãµes');
    } finally {
      setSaving(false);
    }
  }

  if (loading) return <div>Carregando...</div>;

  return (
    <div className="whatsapp-automation">
      <h1>ğŸ‚ AutomaÃ§Ãµes de AniversÃ¡rio</h1>
      
      {/* ConfiguraÃ§Ãµes Gerais */}
      <section className="general-settings">
        <h2>âš™ï¸ ConfiguraÃ§Ãµes Gerais</h2>
        <label>
          <input
            type="checkbox"
            checked={settings.isActive}
            onChange={(e) => setSettings({ ...settings, isActive: e.target.checked })}
          />
          Ativar automaÃ§Ãµes de aniversÃ¡rio
        </label>
        
        <label>
          HorÃ¡rio de envio:
          <select
            value={settings.sendHour}
            onChange={(e) => setSettings({ ...settings, sendHour: parseInt(e.target.value) })}
          >
            {[...Array(24)].map((_, i) => (
              <option key={i} value={i}>{i}:00</option>
            ))}
          </select>
        </label>
      </section>
      
      {/* PrÃ©-AniversÃ¡rio */}
      <section className="pre-birthday">
        <h2>ğŸ“… Mensagem de PrÃ©-AniversÃ¡rio</h2>
        <label>
          <input
            type="checkbox"
            checked={settings.preBirthdayEnabled}
            onChange={(e) => setSettings({ ...settings, preBirthdayEnabled: e.target.checked })}
          />
          Enviar mensagem antes do aniversÃ¡rio
        </label>
        
        <label>
          Enviar com:
          <select
            value={settings.preBirthdayDays}
            onChange={(e) => setSettings({ ...settings, preBirthdayDays: parseInt(e.target.value) })}
          >
            <option value={7}>7 dias de antecedÃªncia</option>
            <option value={15}>15 dias de antecedÃªncia</option>
            <option value={30}>30 dias de antecedÃªncia</option>
            <option value={60}>60 dias de antecedÃªncia</option>
          </select>
        </label>
        
        <label>
          Cashback extra:
          <select
            value={settings.preBirthdayCashbackExtra}
            onChange={(e) => setSettings({ ...settings, preBirthdayCashbackExtra: parseInt(e.target.value) })}
          >
            {[10, 15, 20, 25, 30].map(v => (
              <option key={v} value={v}>{v}%</option>
            ))}
          </select>
        </label>
        
        <div className="preview">
          <h3>Preview da mensagem:</h3>
          <div className="message-preview">
            ğŸ‰ OlÃ¡ JoÃ£o! Seu aniversÃ¡rio estÃ¡ chegando!<br/><br/>
            Faltam apenas {settings.preBirthdayDays} dias para o seu grande dia e preparamos algo especial:<br/><br/>
            ğŸ <strong>{settings.preBirthdayCashbackExtra}% DE CASHBACK EXTRA</strong> em todas as suas compras atÃ© o dia do seu aniversÃ¡rio!<br/><br/>
            Aproveite agora: [Link Dashboard]<br/><br/>
            <em>Local CashBack - Seu cashback, suas vantagens! ğŸ’°</em>
          </div>
        </div>
      </section>
      
      {/* Dia do AniversÃ¡rio */}
      <section className="birthday-day">
        <h2>ğŸ‚ Mensagem no Dia do AniversÃ¡rio</h2>
        <label>
          <input
            type="checkbox"
            checked={settings.birthdayEnabled}
            onChange={(e) => setSettings({ ...settings, birthdayEnabled: e.target.checked })}
          />
          Enviar mensagem no dia do aniversÃ¡rio
        </label>
        
        <label>
          BÃ´nus de aniversÃ¡rio:
          <select
            value={settings.birthdayBonusAmount}
            onChange={(e) => setSettings({ ...settings, birthdayBonusAmount: parseFloat(e.target.value) })}
          >
            {[5, 10, 15, 20, 50].map(v => (
              <option key={v} value={v}>R$ {v.toFixed(2)}</option>
            ))}
          </select>
        </label>
        
        <label>
          Cashback extra no dia:
          <select
            value={settings.birthdayCashbackExtra}
            onChange={(e) => setSettings({ ...settings, birthdayCashbackExtra: parseInt(e.target.value) })}
          >
            {[15, 20, 25, 30, 50].map(v => (
              <option key={v} value={v}>{v}%</option>
            ))}
          </select>
        </label>
        
        <div className="preview">
          <h3>Preview da mensagem:</h3>
          <div className="message-preview">
            ğŸ‚ <strong>PARABÃ‰NS, JoÃ£o!</strong> ğŸ‰<br/><br/>
            Hoje Ã© o SEU dia! Para comemorar, vocÃª ganhou:<br/><br/>
            ğŸ <strong>R$ {settings.birthdayBonusAmount.toFixed(2)} de BÃ”NUS</strong> direto na sua conta!<br/>
            ğŸ’° <strong>{settings.birthdayCashbackExtra}% de CASHBACK EXTRA</strong> em todas as compras hoje!<br/><br/>
            Seu saldo atual: R$ 45,00<br/><br/>
            Acesse: [Link Dashboard]<br/><br/>
            Feliz AniversÃ¡rio! ğŸ¥³<br/>
            <em>Local CashBack</em>
          </div>
        </div>
      </section>
      
      {/* EstatÃ­sticas */}
      {stats && (
        <section className="stats">
          <h2>ğŸ“Š EstatÃ­sticas (Ãšltimos 30 dias)</h2>
          <div className="stats-grid">
            <div className="stat-card">
              <div className="stat-value">{stats.preBirthdayCount}</div>
              <div className="stat-label">Mensagens prÃ©-aniversÃ¡rio</div>
            </div>
            <div className="stat-card">
              <div className="stat-value">{stats.birthdayCount}</div>
              <div className="stat-label">Mensagens de aniversÃ¡rio</div>
            </div>
            <div className="stat-card">
              <div className="stat-value">R$ {stats.totalBonus.toFixed(2)}</div>
              <div className="stat-label">Total em bÃ´nus</div>
            </div>
            <div className="stat-card">
              <div className="stat-value">{stats.successRate}%</div>
              <div className="stat-label">Taxa de sucesso</div>
            </div>
          </div>
        </section>
      )}
      
      {/* PrÃ³ximos Aniversariantes */}
      <section className="upcoming">
        <h2>ğŸ“… PrÃ³ximos 30 dias ({upcoming.length} aniversariantes)</h2>
        {upcoming.length === 0 ? (
          <p>Nenhum aniversariante nos prÃ³ximos 30 dias</p>
        ) : (
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Cliente</th>
                <th>Telefone</th>
                <th>Saldo Atual</th>
              </tr>
            </thead>
            <tbody>
              {upcoming.map(c => (
                <tr key={c.id}>
                  <td>{new Date(c.birthdate).toLocaleDateString('pt-BR')}</td>
                  <td>{c.name}</td>
                  <td>{c.phone}</td>
                  <td>R$ {c.cashback_balance.toFixed(2)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </section>
      
      {/* BotÃ£o Salvar */}
      <button 
        onClick={handleSave} 
        disabled={saving}
        className="save-button"
      >
        {saving ? 'ğŸ’¾ Salvando...' : 'ğŸ’¾ Salvar ConfiguraÃ§Ãµes'}
      </button>
    </div>
  );
}
```

---

## ğŸ”„ **Como o Cron Job Usa as ConfiguraÃ§Ãµes**

```javascript
// ModificaÃ§Ã£o no cron job do server.js

async function checkBirthday30Days() {
  // Buscar merchants com automaÃ§Ã£o ativa
  const { data: merchantSettings } = await supabase
    .from('whatsapp_automation_settings')
    .select('merchant_id, pre_birthday_days, pre_birthday_cashback_extra')
    .eq('is_active', true)
    .eq('pre_birthday_enabled', true);
  
  for (const setting of merchantSettings || []) {
    // Calcular data baseada nas configuraÃ§Ãµes
    const targetDate = new Date();
    targetDate.setDate(targetDate.getDate() + setting.pre_birthday_days);
    const monthDay = targetDate.toISOString().substring(5, 10);
    
    // Buscar clientes deste merchant com aniversÃ¡rio na data alvo
    const { data: customers } = await supabase
      .from('customers')
      .select('*')
      .eq('merchant_id', setting.merchant_id)
      .not('birthdate', 'is', null)
      .ilike('birthdate', `%${monthDay}`);
    
    // Enviar mensagens usando as configuraÃ§Ãµes personalizadas
    for (const customer of customers || []) {
      await sendBirthdayPromo30Days(customer, setting);
    }
  }
}
```

---

## âœ… **O QUE O MERCHANT CONTROLA**

| ConfiguraÃ§Ã£o | Merchant Pode Alterar? | Precisa AprovaÃ§Ã£o Meta? |
|-------------|------------------------|-------------------------|
| âœ… Ativar/Desativar | SIM | NÃƒO |
| âœ… HorÃ¡rio de envio (9h, 10h, etc) | SIM | NÃƒO |
| âœ… Dias antes (7, 15, 30, 60) | SIM | NÃƒO |
| âœ… % Cashback extra (10%, 15%, 20%...) | SIM | NÃƒO |
| âœ… Valor do bÃ´nus (R$ 5, 10, 20...) | SIM | NÃƒO |
| âœ… Ver estatÃ­sticas | SIM | NÃƒO |
| âœ… Ver prÃ³ximos aniversariantes | SIM | NÃƒO |
| âŒ Alterar texto da mensagem | NÃƒO | SIM (Meta aprova) |

---

## ğŸ¯ **Fluxo Completo**

### **1. ConfiguraÃ§Ã£o Inicial (Uma Vez)**
- VocÃª cria os 2 templates na Meta (30 dias + dia do aniversÃ¡rio)
- Meta aprova (1-24h)
- Templates ficam disponÃ­veis para **TODOS** os merchants

### **2. Merchant Configura (Self-Service)**
- Merchant acessa "AutomaÃ§Ãµes de AniversÃ¡rio"
- Define:
  - Dias antes: 30 dias
  - Cashback extra antes: 15%
  - BÃ´nus no dia: R$ 10
  - Cashback extra no dia: 20%
  - HorÃ¡rio: 09:00
- Clica em "Salvar"

### **3. Sistema Roda Automaticamente**
- Cron job Ã s 09:00 (todo dia)
- LÃª as configuraÃ§Ãµes do merchant
- Envia mensagens personalizadas com os valores configurados

---

## ğŸ’° **Custos**

- **Templates Meta**: GRÃTIS (precisa criar 2 vezes apenas)
- **Mensagens**: Primeiras 1.000 conversas/mÃªs GRÃTIS
- **Self-Service**: Merchant configura sem custo adicional

---

## â±ï¸ **Tempo de ImplementaÃ§Ã£o**

| Etapa | Tempo |
|-------|-------|
| Criar tabela `whatsapp_automation_settings` | 15 min |
| Criar endpoints backend (4 endpoints) | 1h |
| Criar painel de controle (frontend) | 2h |
| Modificar cron job para usar configuraÃ§Ãµes | 30 min |
| Testes | 30 min |
| **TOTAL** | **~4 horas** |

---

## ğŸš€ **Resultado Final**

âœ… Merchant configura tudo sozinho (sem mexer com Meta)  
âœ… Valores personalizados por merchant  
âœ… Preview das mensagens em tempo real  
âœ… EstatÃ­sticas de envios  
âœ… Lista de prÃ³ximos aniversariantes  
âœ… Sistema 100% automatizado  

---

**Quer que eu implemente esse painel de controle?** ğŸ¯

---

**Criado**: 2026-01-03  
**Ãšltima AtualizaÃ§Ã£o**: 2026-01-03  
**Autor**: GenSpark AI Developer  
**Status**: Pronto para ImplementaÃ§Ã£o
