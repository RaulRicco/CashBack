################################################################################
# COMANDOS PARA DEPLOY RÃPIDO - COPIAR E COLAR
# Sistema de Cashback - CorreÃ§Ã£o de Isolamento de Dados
################################################################################

================================================================================
OPÃ‡ÃƒO 1: DEPLOY AUTOMATIZADO (MAIS RÃPIDO) âš¡
================================================================================

# Conectar ao servidor
ssh usuario@seu-servidor.com

# Navegar para o projeto
cd /var/www/cashback

# Atualizar cÃ³digo e baixar script
git fetch origin genspark_ai_developer && \
git reset --hard origin/genspark_ai_developer && \
chmod +x DEPLOY-ISOLAMENTO-DADOS.sh && \
bash DEPLOY-ISOLAMENTO-DADOS.sh


================================================================================
OPÃ‡ÃƒO 2: COMANDOS MANUAIS (SE O SCRIPT FALHAR) ðŸ”§
================================================================================

# 1. Conectar ao servidor
ssh usuario@seu-servidor.com

# 2. Ir para o projeto
cd /var/www/cashback

# 3. Atualizar cÃ³digo
git fetch origin genspark_ai_developer && \
git reset --hard origin/genspark_ai_developer

# 4. Limpar cache e build anterior
rm -rf node_modules/.vite dist

# 5. Instalar dependÃªncias
npm ci

# 6. Gerar build
npm run build

# 7. Recarregar Nginx
sudo nginx -t && sudo systemctl reload nginx

# 8. Reiniciar integration-proxy (se existir)
pm2 restart integration-proxy


================================================================================
COMANDOS DE VERIFICAÃ‡ÃƒO âœ…
================================================================================

# Verificar se build foi gerado
ls -la dist/

# Ver Ãºltimo commit aplicado
git log -1 --oneline

# Testar Nginx
curl -I http://localhost

# Ver logs do Nginx
sudo tail -20 /var/log/nginx/error.log

# Ver status do PM2
pm2 status

# Ver logs do integration-proxy
pm2 logs integration-proxy --lines 20


================================================================================
COMANDOS DE EMERGÃŠNCIA (REVERTER) ðŸš¨
================================================================================

# Ver backups disponÃ­veis
ls -la /var/www/backups/cashback/

# Restaurar backup especÃ­fico
cd /var/www/cashback && \
rm -rf dist && \
tar -xzf /var/www/backups/cashback/backup_YYYYMMDD_HHMMSS.tar.gz && \
sudo systemctl reload nginx

# OU voltar commit anterior
git log --oneline -5
git reset --hard COMMIT_ANTERIOR
npm run build
sudo systemctl reload nginx


================================================================================
COMANDO ÃšNICO (TUDO DE UMA VEZ) ðŸš€
================================================================================

# Este comando faz TUDO em uma Ãºnica linha:
ssh usuario@seu-servidor.com "cd /var/www/cashback && \
git fetch origin genspark_ai_developer && \
git reset --hard origin/genspark_ai_developer && \
rm -rf node_modules/.vite dist && \
npm ci && \
npm run build && \
sudo nginx -t && sudo systemctl reload nginx && \
pm2 restart integration-proxy 2>/dev/null || true && \
echo 'âœ… Deploy concluÃ­do!' && \
git log -1 --oneline"


================================================================================
VERIFICAR ARQUIVO .ENV (IMPORTANTE!) ðŸ”‘
================================================================================

# Ver variÃ¡veis (sem mostrar valores completos)
cat .env | grep "^VITE_" | sed 's/=.*/=***/'

# Se .env nÃ£o existir, criar:
cat > .env << 'EOF'
VITE_SUPABASE_URL=https://mtylboaluqswdkgljgsd.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10eWxib2FsdXFzd2RrZ2xqZ3NkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzAwNDMyMzIsImV4cCI6MjA0NTYxOTIzMn0.rOWvxiKNLu6kbdQ8PVPxYpzJLf0qKvSbJOB9VeFGn1I
VITE_RESEND_API_KEY=re_gqFK8iHM_CS85k3Gj5Rvkx4VpfEC3b2GF
VITE_RESEND_FROM_EMAIL=onboarding@resend.dev
VITE_RESEND_FROM_NAME=Local CashBack
VITE_ONESIGNAL_APP_ID=e2b2fb1d-4a56-470f-a33a-aeb35e99631d
VITE_ONESIGNAL_REST_API_KEY=os_v2_app_a5p2iaxr4vb7rgzmfymtidtvmyztnkebpfglnc5qxrk4n3ptvtptclrxbsttqlxs
EOF


================================================================================
TESTAR ISOLAMENTO DE DADOS (APÃ“S DEPLOY) ðŸ§ª
================================================================================

# 1. Acesse o dashboard
# URL: https://seu-dominio.com

# 2. FaÃ§a login em um estabelecimento existente
# âœ… Deve mostrar apenas clientes daquele estabelecimento

# 3. Crie um novo estabelecimento
# âœ… Deve mostrar ZERO clientes
# âœ… Deve mostrar ZERO transaÃ§Ãµes

# 4. FaÃ§a uma venda no novo estabelecimento
# âœ… Contador deve ir para 1 cliente

# 5. Volte para o estabelecimento anterior
# âœ… NÃƒO deve mostrar o novo cliente


================================================================================
INFORMAÃ‡Ã•ES DO SERVIDOR ðŸ“Š
================================================================================

# VersÃµes instaladas
node -v
npm -v
nginx -v

# EspaÃ§o em disco
df -h /var/www

# MemÃ³ria disponÃ­vel
free -h

# Processos Node.js
ps aux | grep node


================================================================================
NOTAS IMPORTANTES ðŸ“
================================================================================

âš ï¸  Sempre execute 'git fetch' antes de fazer deploy
âš ï¸  Verifique se o arquivo .env existe e tem todas as variÃ¡veis
âš ï¸  Teste em um estabelecimento de teste antes de usar em produÃ§Ã£o
âš ï¸  Mantenha backups antes de fazer deploy
âš ï¸  Certifique-se de estar na branch 'genspark_ai_developer'

âœ…  Este deploy corrige o problema de isolamento de dados
âœ…  Novos estabelecimentos comeÃ§arÃ£o com contadores zerados
âœ…  Cada loja verÃ¡ apenas seus prÃ³prios clientes
âœ…  EstatÃ­sticas completamente isoladas por estabelecimento


================================================================================
CONTATO E SUPORTE ðŸ’¬
================================================================================

Se tiver problemas:
1. Verifique os logs: sudo tail -f /var/log/nginx/error.log
2. Verifique status: sudo systemctl status nginx
3. Verifique PM2: pm2 logs
4. Revise o arquivo INSTRUCOES-DEPLOY.md para detalhes

Pull Request: https://github.com/RaulRicco/CashBack/pull/2

################################################################################
# FIM DOS COMANDOS
################################################################################
