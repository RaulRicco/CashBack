â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                    â•‘
â•‘     ğŸ”§ CORRIGIR ERRO 409 (CONFLICT) - CONSTRAINT UNIQUE          â•‘
â•‘                                                                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸš¨ PROBLEMA IDENTIFICADO:
   - Erro 409 (Conflict) ao cadastrar cliente
   - Tabela 'customers' tem UNIQUE constraint no campo 'phone'
   - Isso impede o mesmo telefone em estabelecimentos diferentes

âœ… SOLUÃ‡ÃƒO: Remover UNIQUE do phone e criar constraint composta

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“‹ PASSO A PASSO (COPIAR E COLAR):

1ï¸âƒ£ Acesse o Supabase SQL Editor:
   https://supabase.com/dashboard/project/mtylboaluqswdkgljgsd

2ï¸âƒ£ Clique em "+ New Query"

3ï¸âƒ£ COPIE E COLE este SQL (VERSÃƒO SIMPLIFICADA):

-- Remover constraint UNIQUE do phone
ALTER TABLE customers DROP CONSTRAINT IF EXISTS customers_phone_key CASCADE;
ALTER TABLE customers DROP CONSTRAINT IF EXISTS customers_phone_unique CASCADE;
DROP INDEX IF EXISTS customers_phone_key CASCADE;
DROP INDEX IF EXISTS idx_customers_phone CASCADE;

-- Criar constraint composta: phone + merchant_id
ALTER TABLE customers 
ADD CONSTRAINT customers_phone_merchant_unique 
UNIQUE (phone, referred_by_merchant_id);

4ï¸âƒ£ Clique em "RUN"

5ï¸âƒ£ Se der algum erro, tente a VERSÃƒO AUTOMÃTICA abaixo

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âš¡ VERSÃƒO AUTOMÃTICA (Se a versÃ£o acima nÃ£o funcionar):

-- Remove automaticamente QUALQUER constraint UNIQUE do phone
DO $$
DECLARE
    constraint_rec RECORD;
BEGIN
    FOR constraint_rec IN 
        SELECT constraint_name 
        FROM information_schema.table_constraints 
        WHERE table_name = 'customers' 
        AND constraint_type = 'UNIQUE'
        AND constraint_name LIKE '%phone%'
    LOOP
        EXECUTE 'ALTER TABLE customers DROP CONSTRAINT IF EXISTS ' || constraint_rec.constraint_name || ' CASCADE';
        RAISE NOTICE 'Dropped constraint: %', constraint_rec.constraint_name;
    END LOOP;
END $$;

-- Criar constraint composta
ALTER TABLE customers 
ADD CONSTRAINT customers_phone_merchant_unique 
UNIQUE (phone, referred_by_merchant_id);

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ¯ O QUE ESTE SQL FAZ:

ANTES:
âŒ Campo 'phone' tinha UNIQUE constraint
âŒ Telefone 11999999999 sÃ³ podia existir UMA VEZ na tabela inteira
âŒ Bloqueava cadastro em estabelecimentos diferentes

DEPOIS:
âœ… Remove UNIQUE do phone sozinho
âœ… Cria UNIQUE composto: (phone + merchant_id)
âœ… Permite mesmo phone em estabelecimentos diferentes
âœ… Mas impede duplicatas dentro do mesmo estabelecimento

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Š EXEMPLO PRÃTICO:

Telefone: 11999999999

ANTES (com erro 409):
- Restaurant A: cliente ID 1 âœ…
- Restaurant B: ERRO 409 âŒ (phone jÃ¡ existe!)

DEPOIS (funcionando):
- Restaurant A: cliente ID 1 âœ…
- Restaurant B: cliente ID 2 âœ…
- Loja C: cliente ID 3 âœ…

Cada estabelecimento tem seu prÃ³prio registro!

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ” VERIFICAR SE FUNCIONOU:

1. Execute o SQL no Supabase
2. Aguarde "Success"
3. Tente cadastrar um cliente novamente
4. O erro 409 deve desaparecer!

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âš ï¸  SE AINDA DER ERRO:

Me envie:
1. A mensagem de erro completa do SQL
2. O novo erro do console (se ainda houver 409)
3. Vou investigar outros constraints possÃ­veis

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ ARQUIVOS:

ğŸ“„ FIX-CUSTOMERS-CONSTRAINT-409.sql    â† SQL completo com todas opÃ§Ãµes
ğŸ“„ EXECUTAR-FIX-409-AGORA.txt          â† VocÃª estÃ¡ lendo este arquivo

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ’¡ Execute o SQL e me avise o resultado! ğŸš€

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
